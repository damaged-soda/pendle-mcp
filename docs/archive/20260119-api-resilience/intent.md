# Intent: Pendle API 稳定性与可诊断错误增强

Date: 2026-01-19

## 背景
近期真实使用中，多次遇到部分 Pendle API endpoint 非稳定返回（同参数重试也会出现 non-2xx），且失败时错误信息不够“可诊断”，导致需要额外走链上 `RouterStatic` 自行计算兜底。

## 目标（Goals）
- **可诊断错误**：当 Pendle API 返回 non-2xx / 网络错误 / JSON 不合法时，错误里应包含足够的定位信息（status、endpoint/path、query params（脱敏）、response body 截断、重试次数/最终失败原因分类）。
- **内置重试/退避**：对 429/5xx/网络错误引入指数退避 + jitter，并区分“可重试失败”与“参数/权限类失败（不重试）”。
- **健康检查/降级提示**：提供一个 `health/status` 类工具，快速告诉用户哪些 endpoint 当前可用/降级/不可用，减少盲试成本。
- **减少传参误用**：对易错参数做更强的本地校验与提示（在不引入链上依赖的前提下）。

## 非目标（Non-Goals）
- **不引入链上兜底报价**：本 repo 当前架构约束为“仅 Pendle 官方 API v2 作为数据源”。链上 `RouterStatic` 兜底属于跨数据源能力，先作为后续独立提案处理。
- **不大改现有 tool 返回结构**：现有 tools 默认继续透传 Pendle API 的 JSON；错误诊断优先通过异常/错误对象增强完成（必要时再增量增加 debug-only 的返回结构）。

## 验收标准（Acceptance）
- 任意 tool 失败时，用户可从错误中直接判断：是参数问题（4xx）、限流（429）、上游异常（5xx）、还是网络问题；并能看到对应请求的 endpoint/path 与（脱敏的）关键 query 参数。
- 对 429/5xx/网络错误，默认会进行有限次重试；“重试后仍失败”会明确标记且保留最后一次响应片段。
- 提供 `pendle_health`（或同等命名）工具，输出各检查项的状态与耗时，并在失败时带上简短诊断信息。

